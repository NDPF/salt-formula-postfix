{%- from "postfix/map.jinja" import server with context -%}
check:
  remote_smtp_server_{{ server.myorigin }}:
    command: "PATH=$PATH:/etc/sensu/plugins check-smtp.rb -h {{ server.myorigin }} {% if server.get('ssl', {}).get('enabled', False) %} --tls {% endif %}"
    interval: 60
    occurrences: 1
    subscribers:
    - remote-network
  local_postfix_server_smtpd_proc:
    command: "PATH=$PATH:/usr/lib64/nagios/plugins:/usr/lib/nagios/plugins check_procs -C smtpd -u postfix -c 1:10"
    interval: 30
    occurrences: 3
    subscribers:
    - local-postfix-server
  {%- if server.get('amavis', {}).get('enabled', False) %}
  local_postfix_server_amavis_proc_{{ grains['fqdn'] }}:
    command: "PATH=$PATH:/usr/lib64/nagios/plugins:/usr/lib/nagios/plugins check_procs -C amavisd-new -u amavis -c 7"
    interval: 60
    occurrences: 1
    subscribers:
    - {{ grains['fqdn']|replace('.', '-') }}
  {%- endif %}
  {%- if server.get('dkim', {}).get('enabled', False) %}
  local_postfix_server_opendkim_proc_{{ grains['fqdn'] }}:
    command: "PATH=$PATH:/usr/lib64/nagios/plugins:/usr/lib/nagios/plugins check_procs -C opendkim -u opendkim -c 1"
    interval: 60
    occurrences: 1
    subscribers:
    - {{ grains['fqdn']|replace('.', '-') }}
  {%- endif %}
